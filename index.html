<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Visualización VOO ETF</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
      color: #333;
    }

    header {
      display: flex;
      align-items: center;
      background-color: #fff;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    header img {
      height: 60px;
      margin-right: 20px;
    }

    header h1 {
      font-size: 28px;
      margin: 0;
    }

    #controls {
      text-align: center;
      margin: 20px 0;
    }

    .button {
      font-size: 16px;
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      transition: background-color 0.3s;
    }

    .button.active {
      background-color: #28a745 !important;
    }

    #chart {
      width: 95%;
      height: 600px;
      margin: auto;
    }

    #gauges {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin: 30px auto 60px;
      flex-wrap: wrap;
    }

    .gauge-wrapper {
      text-align: center;
    }

    footer {
      text-align: center;
      padding: 10px;
      font-size: 13px;
      color: #999;
    }
  </style>
</head>
<body>

<header>
  <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/49/Vanguard_Group_logo.svg/512px-Vanguard_Group_logo.svg.png" alt="Vanguard Logo">
  <h1>Vanguard S&P 500 ETF - Visualización Dinámica</h1>
</header>

<div id="controls">
  <button id="btnRSI" class="button" onclick="toggleTrace('RSI')">🟠 Alternar RSI</button>
  <button id="btnMACD" class="button" onclick="toggleTrace('MACD')">🔵 Alternar MACD</button>
</div>

<div id="chart"></div>

<div id="gauges">
  <div class="gauge-wrapper">
    <div id="gauge1" style="width:300px;height:250px;"></div>
    <div id="label1"><strong>Cargando...</strong></div>
  </div>
  <div class="gauge-wrapper">
    <div id="gauge2" style="width:300px;height:250px;"></div>
    <div id="label2"><strong>Cargando...</strong></div>
  </div>
  <div class="gauge-wrapper">
    <div id="gauge3" style="width:300px;height:250px;"></div>
    <div id="label3"><strong>Cargando...</strong></div>
  </div>
</div>

<footer>
  © 2025 Visualización desarrollada como proyecto académico
</footer>

<script>
  let trace = {
    x: [], open: [], high: [], low: [], close: [],
    type: 'candlestick', name: 'VOO',
    increasing: { line: { color: 'green' } },
    decreasing: { line: { color: 'red' } },
    xaxis: 'x', yaxis: 'y'
  };

  let rsiTrace = { x: [], y: [], type: 'scatter', mode: 'lines', name: 'RSI', yaxis: 'y2', visible: false };
  let macdTrace = { x: [], y: [], type: 'scatter', mode: 'lines', name: 'MACD', yaxis: 'y3', visible: false };

  let layout = {
    title: 'Simulación Dinámica VOO',
    xaxis: { domain: [0, 1], anchor: 'y' },
    yaxis: { domain: [0.5, 1], title: 'Precio' },
    yaxis2: { domain: [0.25, 0.5], title: 'RSI', anchor: 'x' },
    yaxis3: { domain: [0, 0.25], title: 'MACD', anchor: 'x' },
    height: 800,
    showlegend: true
  };

  let rsiVisible = false;
  let macdVisible = false;

  async function drawChart() {
    const response = await fetch('ohlc.csv');
    const text = await response.text();
    const rows = text.trim().split('\n').slice(1);
    const data = rows.map(r => r.split(','));
    const filtered = data.filter(r => new Date(r[0]) >= new Date("2024-12-27T21:10:05"));

    const times = filtered.map(r => r[0]);
    const open = filtered.map(r => parseFloat(r[1]));
    const high = filtered.map(r => parseFloat(r[2]));
    const low = filtered.map(r => parseFloat(r[3]));
    const close = filtered.map(r => parseFloat(r[4]));
    const rsi = filtered.map(r => parseFloat(r[5]));
    const macd = filtered.map(r => parseFloat(r[6]));

    Plotly.newPlot('chart', [trace, rsiTrace, macdTrace], layout);

    let i = 0;
    const interval = 5000;

    function simulateCandle() {
      if (i >= times.length) return;

      trace.x.push(times[i]);
      trace.open.push(open[i]);
      trace.high.push(high[i]);
      trace.low.push(low[i]);
      trace.close.push(close[i]);

      rsiTrace.x.push(times[i]);
      rsiTrace.y.push(rsi[i]);

      macdTrace.x.push(times[i]);
      macdTrace.y.push(macd[i]);

      Plotly.update('chart', {
        x: [trace.x, rsiTrace.x, macdTrace.x],
        open: [trace.open],
        high: [trace.high],
        low: [trace.low],
        close: [trace.close],
        y: [null, rsiTrace.y, macdTrace.y]
      });

      updateGauge('gauge1', 'label1', macd[i]);
      updateGauge('gauge2', 'label2', rsi[i]);
      updateGauge('gauge3', 'label3', close[i] - open[i] > 0 ? 25 : 5);

      i++;
    }

    setInterval(simulateCandle, interval);
  }

  function updateGauge(gaugeId, labelId, value) {
    let labelText = 'Neutral', color = 'gray';
    if (value >= 20) { labelText = 'Compra fuerte'; color = 'green'; }
    else if (value >= 10) { labelText = 'Comprar'; color = 'blue'; }
    else if (value >= 5) { labelText = 'Neutral'; color = 'orange'; }
    else { labelText = 'Vender'; color = 'red'; }

    Plotly.newPlot(gaugeId, [{
      type: "indicator",
      mode: "gauge+number",
      value: value,
      title: { text: labelText, font: { size: 18 } },
      gauge: {
        axis: { range: [0, 30] },
        bar: { color: color },
        steps: [
          { range: [0, 5], color: "#fbb" },
          { range: [5, 10], color: "#ffe" },
          { range: [10, 20], color: "#cdf" },
          { range: [20, 30], color: "#cfc" }
        ]
      }
    }]);

    document.getElementById(labelId).innerText = labelText;
  }

  function toggleTrace(name) {
    const isRSI = name === 'RSI';
    const traceIndex = isRSI ? 1 : 2;
    const current = isRSI ? rsiVisible : macdVisible;
    const button = document.getElementById(isRSI ? 'btnRSI' : 'btnMACD');

    Plotly.restyle('chart', { visible: current ? false : true }, [traceIndex]);

    if (isRSI) rsiVisible = !rsiVisible;
    else macdVisible = !macdVisible;

    button.classList.toggle('active');
  }

  drawChart();
</script>

</body>
</html>
