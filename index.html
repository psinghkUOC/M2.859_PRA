<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Simulación ETF VOO</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial; text-align: center; background: #f2f2f2; margin: 0; }
    header { background: #800000; color: white; padding: 10px 0; }
    .btn-container { margin-top: 10px; }
    .toggle-btn {
      margin: 5px;
      padding: 8px 12px;
      background: #2d66f7;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .toggle-btn.active {
      background: #28a745; /* verde */
    }
    footer { margin-top: 30px; font-size: 12px; color: gray; }
  </style>
</head>
<body>
  <header>
    <h1>Simulación Dinámica ETF VOO</h1>
  </header>

  <div id="chart" style="width: 100%; height: 600px;"></div>

  <div class="btn-container" id="indicator-buttons"></div>

  <footer>© 2025 Visualización académica</footer>

  <script>
    const indicadores = ['RSI_14', 'MACD_12_26_9', 'ADX_14', 'CCI_20', 'Momentum_10', 'Stochastic_K', 'Ultimate_Oscillator'];
    const indicatorStates = {};
    const indicatorButtons = {};

    let ohlcData = [];
    let currentStep = 0;
    const indicatorHeaders = {};

    function crearBotones() {
      const container = document.getElementById('indicator-buttons');
      indicadores.forEach(ind => {
        const btn = document.createElement('button');
        btn.className = 'toggle-btn';
        btn.innerText = `Alternar ${ind.replace(/_/g, ' ')}`;
        btn.onclick = () => toggleIndicator(ind, btn);
        container.appendChild(btn);
        indicatorStates[ind] = false;
        indicatorButtons[ind] = btn;
      });
    }

    function toggleIndicator(ind, button) {
      indicatorStates[ind] = !indicatorStates[ind];
      button.classList.toggle('active', indicatorStates[ind]);
      updateChart(currentStep);
    }

    function updateChart(step) {
      const datetime = [], open = [], high = [], low = [], close = [];

      for (let i = 0; i <= step; i++) {
        const row = ohlcData[i];
        datetime.push(row[0]);
        open.push(+row[1]);
        high.push(+row[2]);
        low.push(+row[3]);
        close.push(+row[4]);
      }

      const traces = [{
        x: datetime,
        open: open,
        high: high,
        low: low,
        close: close,
        type: 'candlestick',
        name: 'Precio VOO',
        increasing: { line: { color: 'green' } },
        decreasing: { line: { color: 'red' } }
      }];

      indicadores.forEach(ind => {
        if (indicatorStates[ind]) {
          const y = [];
          for (let i = 0; i <= step; i++) {
            const val = ohlcData[i][indicatorHeaders[ind]];
            y.push(val === "" ? null : parseFloat(val));
          }
          traces.push({
            x: datetime,
            y: y,
            type: 'scatter',
            mode: 'lines',
            name: ind.replace(/_/g, ' '),
            yaxis: 'y2',
            line: { width: 2 },
            hoverinfo: 'x+y+name'
          });
        }
      });

      const layout = {
        title: 'Simulación ETF VOO',
        xaxis: { title: 'Tiempo', rangeslider: { visible: false } },
        yaxis: { title: 'Precio' },
        yaxis2: {
          title: 'Indicadores',
          overlaying: 'y',
          side: 'right',
          showgrid: false
        },
        legend: { orientation: 'h', y: -0.2 }
      };

      Plotly.newPlot('chart', traces, layout);
    }

    fetch('ohlc.csv')
      .then(response => response.text())
      .then(text => {
        const rows = text.trim().split('\n');
        const headers = rows[0].split(',');
        ohlcData = rows.slice(1).map(r => r.split(','));

        indicadores.forEach(ind => {
          indicatorHeaders[ind] = headers.indexOf(ind);
        });

        crearBotones();
        simulateChart();
      });

    function simulateChart() {
      function stepForward() {
        if (currentStep >= ohlcData.length) return;
        updateChart(currentStep);
        currentStep++;
        setTimeout(stepForward, 400); // 400 ms entre velas
      }
      stepForward();
    }
  </script>
</body>
</html>